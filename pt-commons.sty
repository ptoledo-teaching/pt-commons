\ProvidesPackage{pt-commons}[2025/04/21 v1.0 PT Commons Package]
\NeedsTeXFormat{LaTeX2e}

% Commons %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Packages
\RequirePackage{adjustbox}
\RequirePackage{colortbl}
\RequirePackage{etoolbox}
\RequirePackage{float}
\RequirePackage{fontawesome5}
\RequirePackage{geometry}
\RequirePackage{graphicx}
\RequirePackage{microtype}
\RequirePackage{newtxsf}
\RequirePackage{ragged2e}
\RequirePackage{tabularray}
\RequirePackage{tcolorbox}
\RequirePackage[absolute,overlay]{textpos}
\RequirePackage{xstring}
% Hyperlinks
\RequirePackage{hyperref}
\hypersetup{
    colorlinks,
    linkcolor=ptlightblue,
    urlcolor=ptlightblue
}
\renewcommand{\UrlFont}{\normalfont}
% Captions handling
\RequirePackage[hypcap=false]{caption}
\captionsetup{
    justification=justified,
    singlelinecheck=true
}
\newcommand{\ptcaption}[2]{\captionof{#1}{#2}}
\newcommand{\ptcaptionsame}[2]{\addtocounter{#1}{-1}\captionof{#1}{#2}}
% Commands
\newcommand{\inlinecode}[1]{{\ttfamily\bfseries\detokenize{#1}}}
\renewcommand{\texttt}[1]{\inlinecode{#1}}
\newcommand{\todayymd}{\the\year/\twodigits\month/\twodigits\day}
% Number to 2 digits number for dates
\newcommand{\twodigits}[1]{%
    \ifnum#1<10%
        0%
    \fi%
    \the#1%
}

% Document metadata commands %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Version control
\newcommand{\version}[1]{\newcommand{\pt@version}{#1}}
\newcommand{\build}[1]{\newcommand{\pt@build}{#1}}
\renewcommand{\date}[1]{\newcommand{\pt@date}{#1}}
\newcommand{\docversion}{
    \ifdefined\pt@version%
        v\pt@version
    \else%
        NA
    \fi%
}
\newcommand{\buildcountfile}{
    \ifdefined\pt@version
        \jobname\pt@version.buildcount
    \else
        \jobname.buildcount
    \fi
}
% Document title
\renewcommand{\title}[1]{\newcommand{\pt@title}{#1}}
\newcommand{\titlesub}[1]{\newcommand{\pt@titlesub}{#1}}
\newcommand{\titlesubsub}[1]{\newcommand{\pt@titlesubsub}{#1}}
% Class information
\newcommand{\classcode}[1]{\newcommand{\pt@classcode}{#1}}
\newcommand{\classsemester}[1]{\newcommand{\pt@classsemester}{#1}}
\newcommand{\classname}[1]{\newcommand{\pt@classname}{#1}}
% Institution information
\newcommand{\workgroup}[1]{\newcommand{\pt@workgroup}{#1}}
\newcommand{\department}[1]{\newcommand{\pt@department}{#1}}
\newcommand{\school}[1]{\newcommand{\pt@school}{#1}}
\newcommand{\university}[1]{\newcommand{\pt@university}{#1}}
% Corporate information
\newcommand{\corporationname}[1]{\newcommand{\pt@corporationname}{#1}}
\newcommand{\corporationdepartment}[1]{\newcommand{\pt@corporationdepartment}{#1}}

% Fonts and encoding %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Encoding
\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
% Fonts
\RequirePackage[sfdefault,tabular,scaled=.85]{FiraSans}
\RequirePackage{fix-cm}
\RequirePackage[scaled=0.85]{inconsolata}

% Language %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\pt@language}{spanish}
\DeclareOption{english}{\renewcommand\pt@language{english}}
\DeclareOption{portuguese}{\renewcommand\pt@language{portuguese}}
\DeclareOption{french}{\renewcommand\pt@language{french}}
\ProcessOptions\relax
\RequirePackage[\pt@language]{babel}
% Listing caption setup if listings package is loaded
\newcommand{\pt@captionsetup@listing}[1]{%
    \@ifundefined{lstlisting}{}{%
        \captionsetup[listing]{#1}%
    }%
}
% Language specific commands
\addto\captionsspanish{
    \renewcommand{\tablename}{Tabla}
    \renewcommand{\listtablename}{Lista de tablas}
    \pt@captionsetup@listing{name=Código}
    \floatname{filetree}{Árbol de archivos}
    \providecommand{\pt@labeltoc}{Tabla de contenidos}
    \providecommand{\pt@labelquestions}{¿Preguntas?}
    \providecommand{\pt@labelbackgroundsource}{Fotografía de fondo}
    \providecommand{\pt@labeltemplatecredit}{Plantilla del tema}
}
\addto\captionsenglish{
    \renewcommand{\tablename}{Table}
    \renewcommand{\listtablename}{Tables}
    \pt@captionsetup@listing{name=Code}
    \floatname{filetree}{File Tree}
    \providecommand{\pt@labeltoc}{Table of Contents}
    \providecommand{\pt@labelquestions}{Questions?}
    \providecommand{\pt@labelbackgroundsource}{Background source}
    \providecommand{\pt@labeltemplatecredit}{Theme template}
}
\addto\captionsfrench{
    \renewcommand{\tablename}{Tableau}
    \renewcommand{\listtablename}{Liste des tableaux}
    \pt@captionsetup@listing{name=Code}
    \floatname{filetree}{Arbre de fichiers}
    \providecommand{\pt@labeltoc}{Table des matières}
    \providecommand{\pt@labelquestions}{Questions ?}
    \providecommand{\pt@labelbackgroundsource}{Source de l'image de fond}
    \providecommand{\pt@labeltemplatecredit}{Modèle du thème}
}
\addto\captionsportuguese{
    \renewcommand{\tablename}{Tabela}
    \renewcommand{\listtablename}{Listas de tabelas}
    \pt@captionsetup@listing{name=Código}
    \floatname{filetree}{Árvore de arquivos}
    \providecommand{\pt@labeltoc}{Sumário}
    \providecommand{\pt@labelquestions}{Perguntas?}
    \providecommand{\pt@labelbackgroundsource}{Fonte da imagem de fundo}
    \providecommand{\pt@labeltemplatecredit}{Modelo do tema}
}

% File Tree %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{dirtree}
\DTsetlength{0.1cm}{0.2cm}{0.1cm}{0.4pt}{0pt}
\setlength{\DTbaselineskip}{0.5cm}
\renewcommand{\DTstyle}{\ttfamily\scriptsize}
\renewcommand{\DTstylecomment}{\normalfont\footnotesize}
\newcommand{\treeicon}[1]{%
    \begingroup%
    \newif\if@iconfound%
    \@iconfoundfalse%
    \newcommand{\iconbox}[1]{\makebox[0.25cm][c]{\faIcon[scale=#1]{##1}}}%
    \def\filename{#1}%
    % Extract extension
    \StrBehind{\filename}{.}[\ext]%
    % Empty
    \IfStrEq{\filename}{}{\iconbox{file}\ \@iconfoundtrue}{}%
    % Archive
    \IfStrEq{\ext}{zip}{\iconbox{file-archive}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{rar}{\iconbox{file-archive}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{tar}{\iconbox{file-archive}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{gz}{\iconbox{file-archive}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{7z}{\iconbox{file-archive}\ #1\@iconfoundtrue}{}%
    % Audio
    \IfStrEq{\ext}{mp3}{\iconbox{file-audio}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{wav}{\iconbox{file-audio}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{ogg}{\iconbox{file-audio}\ #1\@iconfoundtrue}{}%
    % Code
    \IfStrEq{\ext}{c}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{cpp}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{h}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{hpp}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{java}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{py}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{js}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{ts}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{css}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{html}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{xml}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{json}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{sh}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{rb}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{php}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{go}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{rs}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{tex}{\iconbox{file-code}\ #1\@iconfoundtrue}{}%
    % Office
    \IfStrEq{\ext}{xls}{\iconbox{file-excel}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{xlsx}{\iconbox{file-excel}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{doc}{\iconbox{file-word}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{docx}{\iconbox{file-word}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{ppt}{\iconbox{file-powerpoint}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{pptx}{\iconbox{file-powerpoint}\ #1\@iconfoundtrue}{}%
    % Image
    \IfStrEq{\ext}{jpg}{\iconbox{file-image}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{jpeg}{\iconbox{file-image}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{png}{\iconbox{file-image}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{gif}{\iconbox{file-image}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{svg}{\iconbox{file-image}\ #1\@iconfoundtrue}{}%
    % PDF
    \IfStrEq{\ext}{pdf}{\iconbox{file-pdf}\ #1\@iconfoundtrue}{}%
    % Video
    \IfStrEq{\ext}{mp4}{\iconbox{file-video}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{avi}{\iconbox{file-video}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{mov}{\iconbox{file-video}\ #1\@iconfoundtrue}{}%
    \IfStrEq{\ext}{mkv}{\iconbox{file-video}\ #1\@iconfoundtrue}{}%
    % Default
    \if@iconfound\else
        \IfStrEq{\ext}{}{\iconbox{folder-open}\ #1}{\iconbox{file}}%
    \fi%
    \endgroup
}
\newcommand{\treeiconfirst}[1]{%
    \hspace{0.1cm}\treeicon{#1}%
}
\newfloat{filetree}{htbp}{lof}
\newenvironment{ptdirtree}{
    \hspace*{-0.4cm}%
    \begin{minipage}{.875\columnwidth}
        \vspace{0.25cm}
        }{
        \vspace{0.4cm}
    \end{minipage}
}

% Authors handling %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Common variables
\newlength{\lengthname}
\newlength{\lengthmail}
\newlength{\minipagelength}
\newcounter{authorindex}
\setcounter{authorindex}{0}
% Name formatting
\newcommand\authornameentry[2]{#1, #2}
% Email url formating
\newcommand\authoremailentry[1]{\href{mailto:#1}{#1}}
% Adding author
\newcommand\addauthor[4]{%
    \def\pt@authors{true}
    \stepcounter{authorindex}%
    \expandafter\def\csname authornamelast\theauthorindex\endcsname{#2}%
    \expandafter\def\csname authornamefull\theauthorindex\endcsname{\authornameentry{#2}{#1}}
    \expandafter\def\csname authoremailplain\theauthorindex\endcsname{#3}%
    \expandafter\def\csname authoremailurl\theauthorindex\endcsname{\authoremailentry{#3}}
    \expandafter\def\csname authordetails\theauthorindex\endcsname{#4}
    \settowidth{\lengthname}{#1, #2\textsuperscript{\alph{authorindex}}}%
    \settowidth{\lengthmail}{#3}%
    \ifdim\lengthname>\minipagelength
        \setlength{\minipagelength}{\lengthname}%
    \fi
    \ifdim\lengthmail>\minipagelength
        \setlength{\minipagelength}{\lengthmail}%
    \fi
}
\newcommand{\titleauthorsnames}[1]{%
    \count1=1%
    \loop%
    \ifnum\count1<\numexpr\value{authorindex}+1\relax%
    \ifnum\count1>1%
        #1%
    \fi%
    \csname authornamefull\the\count1\endcsname
    \advance\count1 by 1%
    \repeat%
}
\newcommand{\titleauthorsfooter}[1]{%
    \count1=1%
    \loop%
    \ifnum\count1<\numexpr\value{authorindex}+1\relax%
    \ifnum\count1>1%
        #1%
    \fi%
    \csname authornamefull\the\count1\endcsname%
    \ifcsname authoremailurl\the\count1\endcsname%
        \ (\csname authoremailurl\the\count1\endcsname)%
    \fi%
    \advance\count1 by 1%
    \repeat%
}
\newcommand{\titleauthorsboxes}{
    \addtolength{\minipagelength}{3pt}
    \count1=1
    \loop
    \ifnum\count1<\numexpr\value{authorindex}+1\relax
    \begin{minipage}{\minipagelength}
        \centering
        \if\relax\csname authordetails\the\count1\endcsname\relax
            \csname authornamefull\the\count1\endcsname\\
        \else
            \csname authornamefull\the\count1\endcsname\footnotemark[\the\count1]\\
        \fi
        \csname authoremailurl\the\count1\endcsname
    \end{minipage}
    \advance\count1 by 1
    \repeat
}
\newcommand{\titleauthorsfootnotes}{
    \count1=1
    \loop
    \ifnum\count1<\numexpr\value{authorindex}+1\relax
    \if\relax\csname authordetails\the\count1\endcsname\relax
    \else
        \footnotetext[\the\count1]{\csname authordetails\the\count1\endcsname}%
    \fi
    \advance\count1 by 1
    \repeat
}

% Graphics %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Colors
\RequirePackage{xcolor}
\definecolor{ptred}{HTML}{D60019}
\definecolor{ptdarkred}{HTML}{68000C}
\definecolor{ptlightblue}{HTML}{499BDA}
\definecolor{ptblue}{HTML}{004B85}
\definecolor{ptdarkblue}{HTML}{002038}
\definecolor{ptgreen}{HTML}{008452}
\definecolor{ptdarkgreen}{HTML}{003823}
\definecolor{ptyellow}{HTML}{F7AE00}
\definecolor{ptdarkyellow}{HTML}{896000}
\definecolor{ptgray}{HTML}{E0E0E0}
\definecolor{ptdarkgray}{HTML}{949494}
% Images
\newcommand{\background}[1]{\newcommand{\pt@background}{#1}}
\newcommand{\backgroundcredit}[1]{\newcommand{\pt@backgroundcredit}{#1}}
\ifdefined\logo%
    \renewcommand{\logo}[1]{\newcommand{\pt@logo}{#1}}%
\else%
    \newcommand{\logo}[1]{\def\pt@logo{#1}}%
\fi
% Fading
\RequirePackage{tikz}
\usetikzlibrary{fadings}
\tikzfading[
    name=title page picture fading,
    left color=transparent!0,
    right color=transparent!100,
]
% Plots
\RequirePackage{pgfplots}
\usepgfplotslibrary{groupplots}
\pgfplotsset{compat=1.18}
% Macros
\newcommand{\ptfigure}[5]{
    % 1: Position (h, t, b, p)
    % 2: Options (width, height, scale, etc.)
    % 3: Image path
    % 4: Caption
    \begin{figure}[#1]
        \centering
        \includegraphics[#2]{#3}
        \caption{#4}
        \label{fig:#5}
    \end{figure}
}

% Text styling %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Itemize bullets
\def\labelitemi{$\bullet$}
\def\labelitemii{$\bullet$}
\def\labelitemiii{$\bullet$}
\def\labelitemiv{$\bullet$}
% Bulleted list label styles
\def\labelitemi{$\scriptstyle\bullet$}
\def\labelitemii{$\scriptstyle\bullet$}
\def\labelitemiii{$\scriptstyle\bullet$}
\def\labelitemiv{$\scriptstyle\bullet$}
% Numbered list label styles
\def\labelenumi{\theenumi.}
\def\labelenumii{\theenumii.}
\def\labelenumiii{\theenumiii.}
\def\labelenumiv{\theenumiv.}
% Numbered list counter styles
\def\theenumi{\arabic{enumi}}
\def\theenumii{\arabic{enumii}}
\def\theenumiii{\arabic{enumiii}}
\def\theenumiv{\arabic{enumiv}}

% Tables styling %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\BeforeBeginEnvironment{tblr}{\centering}
\AtBeginEnvironment{tblr}{\small}
\newcommand{\cellrotated}[1]{\rotatebox{90}{#1\hspace{4pt}}}
\SetTblrInner{rowsep=0.6pt}
\SetTblrInner{colsep=3pt}
\SetTblrInner{width=\columnwidth}
\NewColumnType{L}[1]{Q[l,t,wd=#1]}
\NewColumnType{C}[1]{Q[c,t,wd=#1]}
\NewColumnType{R}[1]{Q[r,t,wd=#1]}
\NewTableCommand\tableheader{
    \SetRow{
        ptblue!42,
        c,
        font=\bfseries
    }
}
\NewTableCommand\tablesubheader{
    \SetRow{
        ptblue!21
    }
}

% Code styling %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{fancyvrb}
\RequirePackage{minted}
\setminted{
    bgcolor=ptgray!42,
    fontfamily=tt,
    fontsize=\small,
    autogobble=true,
    linenos=true,
    tabsize=4,
    numbersep=5pt,
    baselinestretch=0.75,
    showspaces=false,
    vspace=0.25cm,
}
\newenvironment{ptprintcode}[1]{%
    \VerbatimEnvironment
    \begin{minted}[
    style=bw,
    bgcolor=white,
    frame=single,
    ]{#1}%
}{%
  \end{minted}%
}

% Watermark %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[stamp=false]{draftwatermark}
\newcommand{\setupwatermark}[1]{% 
    \newlength{\@watermarkheight}
    \newlength{\@watermarklen}
    \newlength{\@watermarktargetlen}
    \newlength{\@watermarkwidth}
    \newlength{\@watermarkfinal}
    \begingroup
    % Calculate the watermark size
    \fontsize{5cm}{6cm}\selectfont
    \settowidth{\@watermarkwidth}{#1}%
    \settoheight{\@watermarkheight}{#1}%
    % Choose the smaller dimension between watermark width and height
    \ifdim\@watermarkwidth>\@watermarkheight
        \global\setlength{\@watermarklen}{\@watermarkwidth}%
    \else
        \global\setlength{\@watermarklen}{\@watermarkheight}%
    \fi
    \endgroup
    % Calculate the watermark target size
    \ifdim\paperwidth<\paperheight
        \setlength{\@watermarktargetlen}{1.2\paperwidth}%
    \else
        \setlength{\@watermarktargetlen}{1.2\paperheight}%
    \fi
    \setlength{\@watermarkfinal}{\dimexpr 4cm * \@watermarktargetlen / \@watermarklen \relax}
    % Set watermark properties
    \SetWatermarkText{#1}%
    \SetWatermarkFontSize{\@watermarkfinal}%
    \SetWatermarkAngle{45}%
    \SetWatermarkColor{ptred!21}
    \SetWatermarkHorCenter{0.4\paperwidth}
}
\newcommand{\watermark}[1]{\newcommand{\pt@watermark}{#1}}

% Hooks %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\AtBeginDocument{
    \IfFileExists{\buildcountfile}{%
        \newread\file
        \openin\file=\buildcountfile
        \read\file to\buildcount
        \closein\file
        \ifx\buildcount\empty
            \def\buildcount{0}
        \fi
    }{
        \def\buildcount{0}
    }
    \ifdefined\pt@watermark%
        \DraftwatermarkOptions{stamp=true}
        \setupwatermark{
            \pt@watermark
            \ifdefined\pt@version%
                \ - v\pt@version
                \ifdefined\pt@build
                    \ifdefstring{\pt@build}{auto}{.\buildcount}{.\pt@build}
                \fi
            \else
                \ifdefined\pt@build%
                    \ifdefstring{\pt@build}{auto}{\ - B\buildcount}{\ - B\pt@build}
                \fi
            \fi
        }
    \fi
    \IfFileExists{\buildcountfile}{%
        \newread\file
        \openin\file=\buildcountfile
        \read\file to\buildcount
        \closein\file
        \ifx\buildcount\empty
            \def\buildcount{0}
        \fi
    }{
        \def\buildcount{0}
    }
    \sloppy
}
\AtEndDocument{
    \newwrite\file
    \immediate\openout\file=\buildcountfile
    \edef\next{\number\numexpr\buildcount+1\relax}
    \immediate\write\file{\next}
    \immediate\closeout\file
}
